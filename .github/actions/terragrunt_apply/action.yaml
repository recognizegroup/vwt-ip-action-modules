name: Terragrunt Apply
description: Runs Terragrunt apply and reports failure if occurs 
inputs:
  webhook:
    required: true
    description: "teams webhook"
  terragrunt_download_directory:
    required: true
    description: "Terragrunt download directory"
  working_directory:
    required: false
    default: .
    description: "Location where to execute terragrunt apply command"

runs:
  using: composite
  steps:
    - name: Clean up disk space and create Terraform Download Directory
      run: |
        echo "=== Pre-deployment disk space cleanup ==="
        df -h
        df -i
        
        # Clean up disk space
        sudo rm -rf /tmp/* 2>/dev/null || true
        sudo rm -rf /var/tmp/* 2>/dev/null || true
        sudo rm -rf ~/.cache/* 2>/dev/null || true
        sudo rm -rf /home/runner/.cache/* 2>/dev/null || true
        sudo rm -rf /home/runner/.terraform/* 2>/dev/null || true
        sudo rm -rf /home/runner/.terragrunt-cache/* 2>/dev/null || true
        sudo rm -rf /home/runner/.terraform.d/* 2>/dev/null || true
        sudo rm -rf /usr/local/share/terraform/* 2>/dev/null || true
        sudo rm -rf /usr/local/lib/terraform/* 2>/dev/null || true
        
        # Remove additional caches
        sudo rm -rf /home/runner/.npm/* 2>/dev/null || true
        sudo rm -rf /home/runner/.yarn/* 2>/dev/null || true
        sudo rm -rf /home/runner/.dotnet/* 2>/dev/null || true
        sudo rm -rf /home/runner/.nuget/* 2>/dev/null || true
        sudo rm -rf /home/runner/.local/* 2>/dev/null || true
        sudo rm -rf /home/runner/.config/* 2>/dev/null || true
        
        # Clean up old terragrunt downloads
        rm -rf ${{ inputs.terragrunt_download_directory }}/* --force 2>/dev/null || true
        mkdir --parents ${{ inputs.terragrunt_download_directory }}
        
        # Force garbage collection
        sudo sync
        sudo echo 3 > /proc/sys/vm/drop_caches 2>/dev/null || true
        
        echo "=== Disk space after cleanup ==="
        df -h
        df -i
      working-directory: ${{ inputs.working_directory }}
      shell: bash
    - name: Terragrunt Apply
      run: |
        terragrunt run-all apply --non-interactive --terragrunt-parallelism 5
      working-directory: ${{ inputs.working_directory }}
      shell: bash
    - name: Clean up after deployment
      run: |
        echo "=== Post-deployment cleanup ==="
        # Clean up terragrunt cache and temporary files
        rm -rf ${{ inputs.terragrunt_download_directory }}/* --force 2>/dev/null || true
        rm -rf .terraform/* --force 2>/dev/null || true
        rm -rf .terragrunt-cache/* --force 2>/dev/null || true
        
        # Additional cleanup
        sudo rm -rf /tmp/* 2>/dev/null || true
        sudo rm -rf /var/tmp/* 2>/dev/null || true
        sudo rm -rf ~/.cache/* 2>/dev/null || true
        sudo rm -rf /home/runner/.cache/* 2>/dev/null || true
        
        # Force garbage collection
        sudo sync
        sudo echo 3 > /proc/sys/vm/drop_caches 2>/dev/null || true
        
        echo "=== Final disk space ==="
        df -h
        df -i
      working-directory: ${{ inputs.working_directory }}
      shell: bash
    - name: Notify about failures
      if: ${{ failure() }}
      run: |
        cat << EOF > message.json
        {"@type":"MessageCard","@context":"https://schema.org/extensions","summary":"Pipeline failed!","themeColor":"ff0000","title":"$GITHUB_REPOSITORY pipeline failed 💢!","sections":[{"facts":[{"name":"Repository:","value":"$GITHUB_REPOSITORY"},{"name":"Branch:","value":"$GITHUB_REF_NAME"},{"name":"Commit:","value":"$GITHUB_SHA"}]}],"potentialAction":[{"@type":"OpenUri","name":"View on GitHub","targets":[{"os":"default","uri":"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"}]}]}
        EOF
        curl -X POST ${{ inputs.webhook }} --header 'Content-Type: application/json' -d @message.json
      shell: bash